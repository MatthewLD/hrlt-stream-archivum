<html>

<head>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
		integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<link rel="stylesheet" type="text/css" href="Activity Log.css" title="default">
</head>

<body>
	<div id="activity_0" class="activity_0">
		<div id="activity_notdemo_0" class="activity_notdemo_0">
			<img id="award_0" class="award_0" src="Grafikák/Awards/blue/assist.png">

			<img id="bg_0" class="bg_0" src="Grafikák/Awards/long_blue_left.png">
			<div id="p_0" class="p_0">
				<pre">Játékos #0</pre>
			</div>
		</div>
		<div id="activity_demo_0" class="activity_demo_0">
			<img id="award_0_demo" class="award_0_demo" src="Grafikák/Awards/blue/Demolition.png">
			<div id="demoing_0" class="demoing_0">

				<img id="bg_0_demo" class="bg_0_demo" src="Grafikák/Awards/long_blue_left.png">

				<pre id="p_0_demo" class="p_0_demo">Játékos #0</pre>
			</div>

			<img id="bg_0_demoed" class="bg_0_demo_demoed" src="Grafikák/Awards/long_orange_right.png">

			<pre id="p_0_demoed" class="p_0_demo_demoed">Játékos #0</pre>
		</div>
	</div>

	<div id="activity_1" class="activity_1">
		<div id="activity_notdemo_1" class="activity_notdemo_0">
			<img id="award_1" class="award_0" src="Grafikák/Awards/blue/assist.png">

			<img id="bg_1" class="bg_0" src="Grafikák/Awards/long_blue_left.png">

			<div id="p_1" class="p_0">
				<pre">Játékos #1</pre>
			</div>
		</div>
		<div id="activity_demo_1" class="activity_demo_1">
			<img id="award_1_demo" class="award_0_demo" src="Grafikák/Awards/blue/Demolition.png">
			<div id="demoing_1" class="demoing_1">

				<img id="bg_1_demo" class="bg_0_demo" src="Grafikák/Awards/long_blue_left.png">

				<pre id="p_1_demo" class="p_0_demo">Játékos #1</pre>
			</div>

			<img id="bg_1_demoed" class="bg_0_demo_demoed" src="Grafikák/Awards/long_orange_right.png">

			<pre id="p_1_demoed" class="p_0_demo_demoed">Játékos #1</pre>
		</div>
	</div>

	<div id="activity_2" class="activity_2">
		<div id="activity_notdemo_2" class="activity_notdemo_2">
			<img id="award_2" class="award_0" src="Grafikák/Awards/blue/assist.png">

			<img id="bg_2" class="bg_0" src="Grafikák/Awards/long_blue_left.png">

			<div id="p_2" class="p_0">
				<pre">Játékos #2</pre>
			</div>
		</div>
		<div id="activity_demo_2" class="activity_demo_2">
			<img id="award_2_demo" class="award_0_demo" src="Grafikák/Awards/blue/Demolition.png">
			<div id="demoing_2" class="demoing_2">

				<img id="bg_2_demo" class="bg_0_demo" src="Grafikák/Awards/long_blue_left.png">

				<pre id="p_2_demo" class="p_0_demo">Játékos #2</pre>
			</div>

			<img id="bg_2_demoed" class="bg_0_demo_demoed" src="Grafikák/Awards/long_orange_right.png">

			<pre id="p_2_demoed" class="p_0_demo_demoed">Játékos #2</pre>
		</div>
	</div>

	<div id="activity_3" class="activity_3">
		<div id="activity_notdemo_3" class="activity_notdemo_3">
			<img id="award_3" class="award_0" src="Grafikák/Awards/blue/assist.png">

			<img id="bg_3" class="bg_0" src="Grafikák/Awards/long_blue_left.png">

			<div id="p_3" class="p_0">
				<pre">Játékos #3</pre>
			</div>
		</div>
		<div id="activity_demo_3" class="activity_demo_3">
			<img id="award_3_demo" class="award_0_demo" src="Grafikák/Awards/blue/Demolition.png">
			<div id="demoing_3" class="demoing_3">

				<img id="bg_3_demo" class="bg_0_demo" src="Grafikák/Awards/long_blue_left.png">

				<pre id="p_3_demo" class="p_0_demo">Játékos #3</pre>
			</div>

			<img id="bg_3_demoed" class="bg_0_demo_demoed" src="Grafikák/Awards/long_orange_right.png">

			<pre id="p_3_demoed" class="p_0_demo_demoed">Játékos #3</pre>
		</div>
	</div>

	<div id="activity_4" class="activity_4">
		<div id="activity_notdemo_4" class="activity_notdemo_4">
			<img id="award_4" class="award_0" src="Grafikák/Awards/blue/assist.png">

			<img id="bg_4" class="bg_0" src="Grafikák/Awards/long_blue_left.png">

			<div id="p_4" class="p_0">
				<pre">Játékos #4</pre>
			</div>
		</div>
		<div id="activity_demo_4" class="activity_demo_4">
			<img id="award_4_demo" class="award_0_demo" src="Grafikák/Awards/blue/Demolition.png">
			<div id="demoing_4" class="demoing_4">

				<img id="bg_4_demo" class="bg_0_demo" src="Grafikák/Awards/long_blue_left.png">

				<pre id="p_4_demo" class="p_0_demo">Játékos #4</pre>
			</div>

			<img id="bg_4_demoed" class="bg_0_demo_demoed" src="Grafikák/Awards/long_orange_right.png">

			<pre id="p_4_demoed" class="p_0_demo_demoed">Játékos #4</pre>
		</div>
	</div>

	<div id="activity_5" class="activity_5">
		<div id="activity_notdemo_5" class="activity_notdemo_5">
			<img id="award_5" class="award_0" src="Grafikák/Awards/blue/assist.png">

			<img id="bg_5" class="bg_0" src="Grafikák/Awards/long_blue_left.png">

			<div id="p_5" class="p_0">
				<pre">Játékos #5</pre>
			</div>
		</div>
		<div id="activity_demo_5" class="activity_demo_5">
			<img id="award_5_demo" class="award_0_demo" src="Grafikák/Awards/blue/Demolition.png">
			<div id="demoing_5" class="demoing_5">

				<img id="bg_5_demo" class="bg_0_demo" src="Grafikák/Awards/long_blue_left.png">

				<pre id="p_5_demo" class="p_0_demo">Játékos #5</pre>
			</div>

			<img id="bg_5_demoed" class="bg_0_demo_demoed" src="Grafikák/Awards/long_orange_right.png">

			<pre id="p_5_demoed" class="p_0_demo_demoed">Játékos #5</pre>
		</div>
	</div>

	<div id="activity_6" class="activity_6">
		<div id="activity_notdemo_6" class="activity_notdemo_6">
			<img id="award_6" class="award_0" src="Grafikák/Awards/blue/assist.png">

			<img id="bg_6" class="bg_0" src="Grafikák/Awards/long_blue_left.png">

			<div id="p_6" class="p_0">
				<pre">Játékos #6</pre>
			</div>
		</div>
		<div id="activity_demo_6" class="activity_demo_6">
			<img id="award_6_demo" class="award_0_demo" src="Grafikák/Awards/blue/Demolition.png">
			<div id="demoing_6" class="demoing_6">

				<img id="bg_6_demo" class="bg_0_demo" src="Grafikák/Awards/long_blue_left.png">

				<pre id="p_6_demo" class="p_0_demo">Játékos #6</pre>
			</div>

			<img id="bg_6_demoed" class="bg_0_demo_demoed" src="Grafikák/Awards/long_orange_right.png">

			<pre id="p_6_demoed" class="p_0_demo_demoed">Játékos #6</pre>
		</div>
	</div>





	<!-- Full-width images with number and caption text -->
	<script>
		function connectToBakkesmod() {
			const WsSubscribers = {
				__subscribers: {},
				websocket: undefined,
				webSocketConnected: false,
				registerQueue: [],
				init: function (port, debug, debugFilters) {
					port = port || 49322;
					debug = debug || false;
					if (debug) {
						if (debugFilters !== undefined) {
							console.warn("WebSocket Debug Mode enabled with filtering. Only events not in the filter list will be dumped");
						} else {
							console.warn("WebSocket Debug Mode enabled without filters applied. All events will be dumped to console");
							console.warn("To use filters, pass in an array of 'channel:event' strings to the second parameter of the init function");
						}
					}
					WsSubscribers.webSocket = new WebSocket("ws://localhost:" + port);
					WsSubscribers.webSocket.onmessage = function (event) {
						let jEvent = JSON.parse(event.data);
						if (!jEvent.hasOwnProperty('event')) {
							return;
						}
						let eventSplit = jEvent.event.split(':');
						let channel = eventSplit[0];
						let event_event = eventSplit[1];
						if (debug) {
							if (!debugFilters) {
								console.log(channel, event_event, jEvent);
							} else if (debugFilters && debugFilters.indexOf(jEvent.event) < 0) {
								console.log(channel, event_event, jEvent);
							}
						}
						WsSubscribers.triggerSubscribers(channel, event_event, jEvent.data);
					};
					WsSubscribers.webSocket.onopen = function () {
						WsSubscribers.triggerSubscribers("ws", "open");
						WsSubscribers.webSocketConnected = true;
						WsSubscribers.registerQueue.forEach((r) => {
							WsSubscribers.send("wsRelay", "register", r);
						});
						WsSubscribers.registerQueue = [];
					};
					WsSubscribers.webSocket.onerror = function () {
						WsSubscribers.triggerSubscribers("ws", "error");
						WsSubscribers.webSocketConnected = false;
					};
					WsSubscribers.webSocket.onclose = function () {
						WsSubscribers.triggerSubscribers("ws", "close");
						WsSubscribers.webSocketConnected = false;
						console.log("Could not connect to bakkesmod. Trying to reconnect...");
						setTimeout(function () {
							connectToBakkesmod();
						}, 1000);
					};
				},
				/**
				 * Add callbacks for when certain events are thrown
				 * Execution is guaranteed to be in First In First Out order
				 * @param channels
				 * @param events
				 * @param callback
				 */
				subscribe: function (channels, events, callback) {
					if (typeof channels === "string") {
						let channel = channels;
						channels = [];
						channels.push(channel);
					}
					if (typeof events === "string") {
						let event = events;
						events = [];
						events.push(event);
					}
					channels.forEach(function (c) {
						events.forEach(function (e) {
							if (!WsSubscribers.__subscribers.hasOwnProperty(c)) {
								WsSubscribers.__subscribers[c] = {};
							}
							if (!WsSubscribers.__subscribers[c].hasOwnProperty(e)) {
								WsSubscribers.__subscribers[c][e] = [];
								if (WsSubscribers.webSocketConnected) {
									WsSubscribers.send("wsRelay", "register", `${c}:${e}`);
								} else {
									WsSubscribers.registerQueue.push(`${c}:${e}`);
								}
							}
							WsSubscribers.__subscribers[c][e].push(callback);
						});
					})
				},
				clearEventCallbacks: function (channel, event) {
					if (WsSubscribers.__subscribers.hasOwnProperty(channel) && WsSubscribers.__subscribers[channel].hasOwnProperty(event)) {
						WsSubscribers.__subscribers[channel] = {};
					}
				},
				triggerSubscribers: function (channel, event, data) {
					if (WsSubscribers.__subscribers.hasOwnProperty(channel) && WsSubscribers.__subscribers[channel].hasOwnProperty(event)) {
						WsSubscribers.__subscribers[channel][event].forEach(function (callback) {
							if (callback instanceof Function) {
								callback(data);
							}
						});
					}
				},
				send: function (channel, event, data) {
					if (typeof channel !== 'string') {
						console.error("Channel must be a string");
						return;
					}
					if (typeof event !== 'string') {
						console.error("Event must be a string");
						return;
					}
					if (channel === 'local') {
						this.triggerSubscribers(channel, event, data);
					} else {
						let cEvent = channel + ":" + event;
						WsSubscribers.webSocket.send(JSON.stringify({
							'event': cEvent,
							'data': data
						}));
					}
				}
			};

			var lastVisible = -1;
			var waitplz = false;
			var currentlyVisible = 0;

			$(() => {
				WsSubscribers.init(49322, false);

				WsSubscribers.subscribe("game", "update_state", (d) => {
					console.log(d);
				});

				WsSubscribers.subscribe("game", "statfeed_event", (d) => {
					//console.log("lastVisible: " + lastVisible);
					addToQueue(d);
				});
			});

			function addToQueue(d) {
				if (currentlyVisible > 6) {
					console.log("There's too many to show!");
					setTimeout(function () {
						addToQueue(d);
					}, 1000);
				}
				else {
					currentlyVisible++;
					lastVisible++;
					console.log("currentlyVisible = " + currentlyVisible + " (showed)");
					if (lastVisible > 6) {
						lastVisible = 0;
					}
					manageEvent(lastVisible, d);
				}
			}

			function manageEvent(queue, d) {
				if (d['type'] == 'Demolition') {
					document.getElementById("activity_notdemo_" + queue).style.opacity = "0.0";
					document.getElementById("activity_demo_" + queue).style.opacity = "1.0";

					//Demózott nevének és hátterénekbeállítása
					document.getElementById("p_" + queue + "_demoed").innerHTML = d['secondary_target']['name'];
					document.getElementById("p_" + queue + "_demoed").style.right = "50px";
					let demoedid = parseInt(d['secondary_target']['id'].split("_")[1]);
					let demoedteam;
					if (demoedid < 5) {
						demoedteam = "blue";
					}
					else {
						demoedteam = "orange";
					}

					document.getElementById("bg_" + queue + "_demoed").src = "Grafikák/Awards/long_" + demoedteam + "_right.png";

					var calculatedTextWidth = getTextWidth(d['secondary_target']['name'], getCanvasFontSize(document.getElementById("p_" + queue + "_demoed"))) / 0.3

					document.getElementById("bg_" + queue + "_demoed").style.clip = "rect(0px,1000px,100px," + (1000 - calculatedTextWidth - 110) + "px)";

					//A demó ikonjának tesztreszabása és igazítása

					let id = parseInt(d['main_target']['id'].split("_")[1]);
					var team;
					if (id < 5) {
						team = "blue";
					}
					else {
						team = "orange";
					}

					document.getElementById("award_" + (queue) + "_demo").src = "Grafikák/Awards/" + team + "/" + d['type'] + ".png";
					document.getElementById("award_" + (queue) + "_demo").style.left = document.getElementById("p_" + queue + "_demoed").offsetLeft - 70;

					//Demózó nevének és hatterének beállítása

					document.getElementById("p_" + queue + "_demo").innerHTML = d['main_target']['name'];
					document.getElementById("p_" + queue + "_demo").style.right = 1920 - (document.getElementById("award_" + (queue) + "_demo").offsetLeft) - 30;

					document.getElementById("bg_" + queue + "_demo").src = "Grafikák/Awards/long_" + team + "_left.png";

					document.getElementById("bg_" + queue + "_demo").style.right = 1920 - document.getElementById("p_" + queue + "_demo").offsetLeft - 640;

					calculatedTextWidth = getTextWidth(d['main_target']['name'], getCanvasFontSize(document.getElementById("p_" + queue + "_demo"))) / 0.3

					document.getElementById("bg_" + queue + "_demo").style.clip = "rect(0px," + (calculatedTextWidth + 100) + "px,100px,0px)";

				}
				else {
					document.getElementById("activity_notdemo_" + queue).style.opacity = "1.0";
					document.getElementById("activity_demo_" + queue).style.opacity = "0.0";

					$("#p_" + (queue)).text(d['main_target']['name']);

					let id = parseInt(d['main_target']['id'].split("_")[1]);

					var playerBg = document.getElementById("bg_" + (queue));
					var team;
					if (id < 5) {
						team = "blue";
					}
					else {
						team = "orange";
					}
					playerBg.src = "Grafikák/Awards/long_" + team + "_left.png";

					document.getElementById("award_" + (queue)).src = "Grafikák/Awards/" + team + "/" + d['type'] + ".png";

					var playerNameDoc = document.getElementById("p_" + (queue));
					var leftPosOfName = playerNameDoc.offsetLeft;
					var calculatedTextWidth = getTextWidth(d['main_target']['name'], getCanvasFontSize(playerNameDoc)) / 0.3;

					var leftPos = leftPosOfName - 360;
					var rectFromRight = (calculatedTextWidth + 85);


					document.getElementById("bg_" + (queue)).style.clip = "rect(0px," + (rectFromRight) + "px,100px,0px)";
					document.getElementById("bg_" + (queue)).style.left = leftPos + "px";
				}

				showIt(queue, 0);

				setTimeout(function () {
					remove(queue, 100);
					setTimeout(function () {
						removeFromQueue(queue);
					}, 500);
				}, 4000);
			}

			function getTextWidth(text, font) {
				// re-use canvas object for better performance
				const canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
				const context = canvas.getContext("2d");
				context.font = font;
				const metrics = context.measureText(text);
				return metrics.width;
			}

			function getCssStyle(element, prop) {
				return window.getComputedStyle(element, null).getPropertyValue(prop);
			}

			function getCanvasFontSize(el = document.body) {
				const fontWeight = getCssStyle(el, 'font-weight') || 'normal';
				const fontSize = getCssStyle(el, 'font-size') || '16px';
				const fontFamily = getCssStyle(el, 'font-family') || 'Times New Roman';

				//console.log(`${fontWeight} ${fontSize} ${fontFamily}`);

				return `${fontWeight} ${fontSize} ${fontFamily}`;
			}

			function showIt(queue, opacity) {
				setTimeout(function () {
					var doc = document.getElementById("activity_" + queue);
					if (opacity <= 100) {
						var actualOpacity = opacity / 100;
						doc.style.opacity = actualOpacity;
						showIt(queue, opacity + 1.5);
					}
				}, 1);
			}

			function remove(queue, opacity) {
				setTimeout(function () {
					var doc = document.getElementById("activity_" + queue);
					if (opacity >= 0) {
						var actualOpacity = opacity / 100;
						doc.style.opacity = actualOpacity;
						remove(queue, opacity - 1);
					}
				}, 2);
			}

			function removeFromQueue(queue) {
				while (waitplz) {
					console.log("OK, waiting...");
				}
				if (!waitplz) {
					waitplz;
				}
				for (let i = 0; i < 7; i++) {
					var doc = document.getElementById("activity_" + i);
					//console.log(queue + ": " + i);
					if (doc.offsetTop == -120) {
						doc.style.top = "120px";
					}
					else {
						doc.style.top = (doc.offsetTop - 40) + "px";
					}
				}
				waitplz = false;
				currentlyVisible--;
				console.log("currentlyVisible = " + currentlyVisible + " (disappeared)");
			}
		}

		connectToBakkesmod();

	</script>
	</div>
</body>

</html>